graph TD
    %% Core Engine Layer
    subgraph "Core Engine"
        A[LangGraphGameEngine]
        B[StateGraph]
        C[NodeRegistry]
        D[EventSystem]
    end
    
    %% State Management Layer
    subgraph "State Management"
        E[GameState]
        F[WaidrinState]
        G[LangGraphState]
        H[MemoryState]
        I[PluginState]
    end
    
    %% Node Layer
    subgraph "Game Nodes"
        J[CoreNodes]
        K[DynamicNodes]
        L[UtilityNodes]
    end
    
    subgraph "Core Game Flow"
        M[WelcomeNode]
        N[ConnectionNode]
        O[GenreNode]
        P[CharacterNode]
        Q[ScenarioNode]
        R[ChatNode]
    end
    
    subgraph "Dynamic Game Logic"
        S[NarrationNode]
        T[ActionGenerationNode]
        U[LocationChangeNode]
        V[CharacterIntroductionNode]
        W[MemoryUpdateNode]
        X[SceneSummaryNode]
    end
    
    subgraph "Utility Nodes"
        Y[ErrorHandlingNode]
        Z[UserInputNode]
        AA[StreamingNode]
    end
    
    %% Tool Layer
    subgraph "Tool System"
        BB[LLMTools]
        CC[CharacterTools]
        DD[LocationTools]
        EE[MemoryTools]
        FF[PluginTools]
    end
    
    %% Backend Layer
    subgraph "Backend Integration"
        GG[WaidrinBackend]
        HH[OpenAIClient]
        II[StreamingHandler]
    end
    
    %% Plugin Layer
    subgraph "Plugin System"
        JJ[PluginRegistry]
        KK[PluginLoader]
        LL[PluginExecutor]
    end
    
    %% External Dependencies
    subgraph "External Dependencies"
        MM[LangGraph]
        NN[LangChain]
        OO[Zod]
        PP[Zustand]
        QQ[Immer]
    end
    
    %% Core Engine Connections
    A --> B
    A --> C
    A --> D
    A --> E
    
    %% State Management Connections
    E --> F
    E --> G
    E --> H
    E --> I
    
    %% Node System Connections
    B --> J
    B --> K
    B --> L
    
    J --> M
    J --> N
    J --> O
    J --> P
    J --> Q
    J --> R
    
    K --> S
    K --> T
    K --> U
    K --> V
    K --> W
    K --> X
    
    L --> Y
    L --> Z
    L --> AA
    
    %% Tool System Connections
    S --> BB
    T --> BB
    U --> DD
    V --> CC
    W --> EE
    X --> EE
    
    %% Backend Connections
    BB --> HH
    BB --> II
    HH --> GG
    II --> GG
    
    %% Plugin Connections
    JJ --> KK
    JJ --> LL
    KK --> MM
    LL --> MM
    
    %% External Dependencies
    A --> MM
    B --> MM
    E --> OO
    E --> PP
    E --> QQ
    BB --> NN
    
    %% Styling
    classDef coreEngine fill:#e1f5fe
    classDef stateManagement fill:#f3e5f5
    classDef gameNodes fill:#e8f5e8
    classDef toolSystem fill:#fff3e0
    classDef backend fill:#fce4ec
    classDef plugin fill:#f1f8e9
    classDef external fill:#f5f5f5
    
    class A,B,C,D coreEngine
    class E,F,G,H,I stateManagement
    class J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,AA gameNodes
    class BB,CC,DD,EE,FF toolSystem
    class GG,HH,II backend
    class JJ,KK,LL plugin
    class MM,NN,OO,PP,QQ external
